<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Bell System | All Events</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;900&family=Montserrat:wght@700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    crossorigin="anonymous"
  />
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #f0f4f8 0%, #daf0ff 100%);
      --text-color: #232b33;
      --card-bg: #ffffffcc;
      --accent: #287ee6;
      --accent-light: #61a0ee;
      --header-gradient: linear-gradient(90deg, #287ee6 0%, #43e97b 100%);
      --shadow-card: 0 8px 32px 0 rgba(60, 90, 130, 0.15);
      --shadow-btn: 0 4px 12px 0 rgba(40, 126, 230, 0.12);
    }
    [data-theme="dark"] {
      --bg-gradient: linear-gradient(135deg, #2a2b38 0%, #1a272e 100%);
      --text-color: #e0f6ff;
      --card-bg: #222231cc;
      --accent: #43e97b;
      --accent-light: #2979ff;
      --header-gradient: linear-gradient(90deg, #1f4c70 0%, #43e97b 100%);
      --shadow-card: 0 8px 40px 0 rgba(20,40,70,0.35);
      --shadow-btn: 0 4px 14px 0 rgba(67,233,123,0.18);
    }
    html,
    body {
      height: 100%;
      min-height: 100vh;
      background: var(--bg-gradient);
      color: var(--text-color);
      margin: 0;
      font-family: "Roboto", sans-serif;
      transition: background 0.6s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s;
    }

    /* Header */
    .header {
      background: var(--header-gradient);
      color: #fff;
      font-size: 2rem;
      font-family: "Montserrat", sans-serif;
      font-weight: 700;
      letter-spacing: 2px;
      border-radius: 18px;
      box-shadow: var(--shadow-card);
      padding: 30px 40px 24px 40px;
      text-align: center;
      margin: 35px 0 20px 0;
      position: relative;
      user-select: none;
    }
    #digital-clock {
      font-size: 1.3rem;
      margin-bottom: 7px;
      font-family: "Montserrat", sans-serif;
      font-weight: 700;
      letter-spacing: 1px;
      color: #e3ffd9;
      text-shadow: 0 2px 7px rgba(40, 126, 230, 0.14);
      animation: fadein-up 900ms;
    }

    /* Header links container */
    .header-links {
      position: absolute;
      top: 36px;
      right: 30px;
      display: flex;
      gap: 12px;
      align-items: center;
      font-family: "Montserrat", sans-serif;
      font-size: 16px;
    }
    .header-links a {
      text-decoration: none;
      padding: 6px 14px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.13);
      color: #fff;
      box-shadow: 0 1px 4px 0 rgba(40, 126, 230, 0.04);
      transition: background 0.3s ease, color 0.15s ease;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }
    .header-links a:hover {
      background: var(--accent);
      color: #fff;
    }
    .btn-view-today {
      background: #fff;
      color: var(--accent);
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(40, 126, 230, 0.2);
    }
    .btn-view-today:hover {
      background: #d9eaff;
      color: var(--accent);
    }

    .current-alarms {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--shadow-card);
      padding: 40px 40px 35px 40px;
      max-width: 680px;
      margin: 0 auto 24px auto;
      backdrop-filter: blur(2.5px);
      animation: fadein-up 1.2s;
      transition: background 0.3s;
    }
    @keyframes fadein-up {
      0% {
        opacity: 0;
        transform: translateY(32px);
      }
      100% {
        opacity: 1;
        transform: none;
      }
    }
    .current-alarms h2 {
      border-bottom: 2px solid var(--accent);
      padding-bottom: 10px;
      margin-bottom: 20px;
      font-size: 1.27rem;
      color: var(--accent);
      font-family: "Montserrat", sans-serif;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 1px;
    }
    #normal-events-list,
    #special-events-list {
      min-height: 70px;
      margin-bottom: 32px;
      padding: 20px 16px;
      background: rgba(97, 160, 238, 0.065);
      border-radius: 13px;
      box-shadow: 0 3px 10px rgba(40, 126, 230, 0.06);
      font-size: 1.07rem;
      transition: background 0.2s;
      animation: fadein-up 1.35s;
    }
    .event-card {
      background: rgba(255, 255, 255, 0.85);
      margin-bottom: 17px;
      border-radius: 9px;
      box-shadow: 0 1px 8px 0 rgba(40, 126, 230, 0.07);
      padding: 14px 18px 13px 18px;
      display: flex;
      align-items: flex-start;
      gap: 14px;
      position: relative;
      transition: box-shadow 0.22s;
      animation: fadein-up 1.3s;
    }
    .event-card i {
      font-size: 1.33rem;
      color: var(--accent);
      margin-top: 2px;
      opacity: 0.8;
    }
    .event-details {
      flex: 1;
    }
    .event-title {
      font-weight: bold;
      font-size: 1.09rem;
      letter-spacing: 0.7px;
      margin-bottom: 4px;
    }
    .event-meta {
      font-size: 0.98rem;
      color: #4660aa;
      font-style: italic;
      margin-bottom: 6px;
    }
    .event-status {
      font-size: 0.95rem;
      color: #348060;
      margin-top: 2px;
      opacity: 0.88;
    }
    .event-card.done .event-status {
      color: #6fbf73;
      font-weight: 700;
      opacity: 1;
    }
    .event-card.pending .event-status {
      color: #f59e42;
      font-weight: 700;
    }
    .no-events {
      font-style: italic;
      color: #888aa9;
      padding: 8px;
      font-size: 1rem;
      text-align: center;
    }

    /* Buttons for edit & delete */
    .btn-group {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .btn-edit,
    .btn-delete {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background-color 0.25s ease;
      user-select: none;
    }
    .btn-edit {
      background-color: #287ee6;
      color: white;
    }
    .btn-edit:hover {
      background-color: #1e5ab3;
    }
    .btn-delete {
      background-color: #e63f3f;
      color: white;
    }
    .btn-delete:hover {
      background-color: #b82b2b;
    }

    /* Floating Add New Event plus button at bottom */
    footer {
      margin-top: 35px;
      text-align: center;
      color: #5e7996;
      font-size: 1.07rem;
      opacity: 0.75;
      letter-spacing: 0.1px;
      position: relative;
      min-height: 80px;
    }
    footer a {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
    }
    .bottom {
      background: var(--accent);
      color: white;
      border: none;
      padding: 20px 30px;
      border-radius: 50%;
      font-size: 2.5rem;
      box-shadow: var(--shadow-btn);
      cursor: pointer;
      transition: background 0.25s, box-shadow 0.18s;
      user-select: none;
    }
    .bottom:hover {
      background: var(--accent-light);
      box-shadow: 0 8px 30px var(--accent-light);
    }

    /* Edit panel styles */
    #edit-panel {
      max-width: 680px;
      margin: 24px auto;
      padding: 25px 30px;
      border-radius: 20px;
      background: var(--card-bg);
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(2.5px);
      font-size: 1.07rem;
      animation: fadein-up 1s;
      display: none; /* hidden by default */
      user-select: none;
    }
    #edit-panel h3 {
      margin-top: 0;
      margin-bottom: 18px;
      color: var(--accent);
      font-weight: 700;
      font-family: "Montserrat", sans-serif;
    }
    #edit-panel label {
      display: block;
      margin-top: 14px;
      font-weight: 600;
    }
    #edit-panel input[type="text"],
    #edit-panel input[type="time"],
    #edit-panel input[type="date"],
    #edit-panel select {
      margin-top: 6px;
      padding: 8px 12px;
      font-size: 1rem;
      width: 100%;
      border-radius: 7px;
      border: 1.5px solid #aaa;
      transition: border-color 0.25s ease;
      box-sizing: border-box;
      font-family: "Roboto", sans-serif;
    }
    #edit-panel input[type="checkbox"] {
      margin-left: 6px;
      cursor: pointer;
      width: auto;
      height: 18px;
      vertical-align: middle;
    }
    #edit-panel button {
      margin-top: 24px;
      padding: 14px 26px;
      border-radius: 9px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
    }
    #edit-panel button:hover {
      background: var(--accent-light);
    }
    #edit-cancel {
      background: #e63f3f;
      margin-left: 10px;
      padding: 14px 22px;
    }
    #edit-cancel:hover {
      background: #b82b2b;
    }
    .error-message {
      color: #e63f3f;
      margin-top: 8px;
      font-weight: 600;
      display: none;
    }
    #edit-frequency-group {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    #edit-frequency-group label {
      font-weight: normal;
      font-size: 0.91rem;
      user-select: none;
    }

    @media (max-width: 700px) {
      .current-alarms {
        padding: 19px 5vw 20px 5vw;
      }
      .header {
        font-size: 1.3rem;
        padding: 16px 12px 12px 12px;
      }
      .header-links {
        position: static;
        margin-top: 10px;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
      }
      #edit-panel {
        padding: 20px 20px;
      }
      footer a {
        bottom: 20px;
        right: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div id="digital-clock" aria-live="polite" aria-atomic="true" role="timer"></div>
    MANAGE BELL EVENTS

    <nav class="header-links" aria-label="Main navigation">
      <a href="settings.html" title="Settings" tabindex="0">Settings</a>
      <a href="todays-events.html" title="Today's Events" tabindex="0">Today's Events</a>
      <a href="todays-events.html" title="View Today's Events" class="btn-view-today" tabindex="0" role="button">View Today's Events</a>
    </nav>
  </div>

  <main class="current-alarms" aria-live="polite" aria-atomic="true">
    <h2><i class="fa-regular fa-bell"></i> Normal Events</h2>
    <div id="normal-events-list"><span class="no-events">Loading normal events...</span></div>

    <h2><i class="fa-solid fa-star"></i> Special Events</h2>
    <div id="special-events-list"><span class="no-events">Loading special events...</span></div>
  </main>

  <!-- Edit event panel -->
  <section id="edit-panel" aria-live="polite" aria-atomic="true" aria-label="Edit event details">
    <h3>Edit Event</h3>
    <form id="edit-form" novalidate>
      <input type="hidden" id="edit-id" />
      <input type="hidden" id="edit-type" />

      <!-- Normal Event fields -->
      <div id="edit-normal-fields" class="edit-fields">
        <label for="edit-title">Title *</label>
        <input type="text" id="edit-title" required autocomplete="off" />

        <label for="edit-time">Time *</label>
        <input type="time" id="edit-time" required />

        <label for="edit-delay">Delay (seconds)</label>
        <input type="text" id="edit-delay" autocomplete="off" />

        <label for="edit-tone">Tone *</label>
        <select id="edit-tone" required>
          <option value="">Select a tone</option>
          <option value="tone1">Tone 1</option>
          <option value="tone2">Tone 2</option>
          <option value="tone3">Tone 3</option>
        </select>

        <label>
          <input type="checkbox" id="edit-active" />
          Active
        </label>

        <label>Frequency *</label>
        <div id="edit-frequency-group" aria-label="Select frequency days">
          <label><input type="checkbox" value="monday" /> Monday</label>
          <label><input type="checkbox" value="tuesday" /> Tuesday</label>
          <label><input type="checkbox" value="wednesday" /> Wednesday</label>
          <label><input type="checkbox" value="thursday" /> Thursday</label>
          <label><input type="checkbox" value="friday" /> Friday</label>
          <label><input type="checkbox" value="saturday" /> Saturday</label>
          <label><input type="checkbox" value="sunday" /> Sunday</label>
        </div>
      </div>

      <!-- Special Event fields -->
      <div id="edit-special-fields" class="edit-fields" style="display:none;">
        <label for="edit-date">Date *</label>
        <input type="date" id="edit-date" required />

        <label for="edit-time-special">Time *</label>
        <input type="time" id="edit-time-special" required />

        <label for="edit-description">Description *</label>
        <input type="text" id="edit-description" required autocomplete="off" />

        <label for="edit-tone-special">Tone *</label>
        <select id="edit-tone-special" required>
          <option value="">Select a tone</option>
          <option value="tone1">Tone 1</option>
          <option value="tone2">Tone 2</option>
          <option value="tone3">Tone 3</option>
        </select>

        <label>
          <input type="checkbox" id="edit-completed" />
          Completed
        </label>
      </div>

      <div id="edit-error" class="error-message"></div>

      <button type="submit">Save Changes</button>
      <button type="button" id="edit-cancel">Cancel</button>
    </form>
  </section>

  <footer>
    <a href="ADD NEW EVENT.html" aria-label="Add New Event">
      <button id="weka-alarm" class="bottom" title="Add New Event">+</button>
    </a>
  </footer>

  <script>
    const API_BASE = "http://localhost:5000/api";

    // Update digital clock every second
    function updateClock() {
      const clock = document.getElementById("digital-clock");
      const now = new Date();
      clock.innerText = now.toLocaleTimeString();
    }

    function renderNormalEvent(ev) {
      const freq = Array.isArray(ev.frequency) ? ev.frequency.join(", ") : ev.frequency;
      return `
        <div class="event-card" data-id="${ev.id}" data-type="normal">
          <i class="fa-regular fa-bell"></i>
          <div class="event-details">
            <div class="event-title">${ev.title} — <span style="color:#287ee6">${ev.time}</span></div>
            <div class="event-meta"><i class="fa-solid fa-calendar-days"></i> Days: ${freq}</div>
            ${
              ev.active
                ? `<div class="event-status">Active</div>`
                : `<div class="event-status" style="color:#888a99;">Inactive</div>`
            }
            <div class="btn-group">
              <button class="btn-edit" data-id="${ev.id}" data-type="normal" aria-label="Edit normal event ${ev.title}">Edit</button>
              <button class="btn-delete" data-id="${ev.id}" data-type="normal" aria-label="Delete normal event ${ev.title}">Delete</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderSpecialEvent(ev) {
      const statusClass = ev.completed ? "done" : "pending";
      const status = ev.completed ? "✅ Done" : "⏳ Pending";
      return `
        <div class="event-card ${statusClass}" data-id="${ev.id}" data-type="special">
          <i class="fa-solid fa-star"></i>
          <div class="event-details">
            <div class="event-title">${ev.description} — <span style="color:#43e97b">${ev.time}</span></div>
            <div class="event-meta"><i class="fa-solid fa-calendar-day"></i> ${ev.date}</div>
            <div class="event-status">${status}</div>
            <div class="btn-group">
              <button class="btn-edit" data-id="${ev.id}" data-type="special" aria-label="Edit special event ${ev.description}">Edit</button>
              <button class="btn-delete" data-id="${ev.id}" data-type="special" aria-label="Delete special event ${ev.description}">Delete</button>
            </div>
          </div>
        </div>
      `;
    }

    async function fetchNormalEvents() {
      try {
        const res = await fetch(`${API_BASE}/normalEvents`);
        if (!res.ok) throw new Error("Failed to fetch normal events");
        return await res.json();
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    async function fetchSpecialEvents() {
      try {
        const res = await fetch(`${API_BASE}/specialEvents`);
        if (!res.ok) throw new Error("Failed to fetch special events");
        return await res.json();
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    async function populateEvents() {
      const normalList = document.getElementById("normal-events-list");
      const specialList = document.getElementById("special-events-list");

      const normalEvents = await fetchNormalEvents();
      normalList.innerHTML = normalEvents.length
        ? normalEvents.map(renderNormalEvent).join("")
        : `<span class="no-events"><i class="fa-regular fa-face-smile-wink"></i> No normal events scheduled.</span>`;

      const specialEvents = await fetchSpecialEvents();
      specialList.innerHTML = specialEvents.length
        ? specialEvents.map(renderSpecialEvent).join("")
        : `<span class="no-events"><i class="fa-regular fa-face-smile-wink"></i> No special events scheduled.</span>`;

      attachEventButtonsListeners();
    }

    function attachEventButtonsListeners() {
      // Edit buttons
      document.querySelectorAll(".btn-edit").forEach((btn) => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const type = btn.dataset.type;
          showEditPanel(id, type);
        };
      });

      // Delete buttons
      document.querySelectorAll(".btn-delete").forEach((btn) => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const type = btn.dataset.type;
          if (!confirm(`Confirm delete of ${type} event ID ${id}?`)) return;
          try {
            const res = await fetch(`${API_BASE}/${type}Events/${id}`, {
              method: "DELETE",
            });
            const data = await res.json();
            if (res.ok) {
              alert(data.message || "Deleted successfully");
              populateEvents();
              hideEditPanel();
            } else {
              alert(`Delete failed: ${data.error || "Unknown error"}`);
            }
          } catch (err) {
            alert("Error deleting event: " + err);
          }
        };
      });
    }

    async function showEditPanel(id, type) {
      const panel = document.getElementById("edit-panel");
      const editError = document.getElementById("edit-error");
      editError.style.display = "none";
      editError.textContent = "";

      try {
        const res = await fetch(`${API_BASE}/${type}Events/${id}`);
        if (!res.ok) throw new Error("Event fetch failed");
        const ev = await res.json();

        document.getElementById("edit-id").value = id;
        document.getElementById("edit-type").value = type;

        if (type === "normal") {
          document.getElementById("edit-normal-fields").style.display = "";
          document.getElementById("edit-special-fields").style.display = "none";

          document.getElementById("edit-title").value = ev.title || "";
          document.getElementById("edit-time").value = ev.time || "";
          document.getElementById("edit-delay").value = ev.delay || 0;
          document.getElementById("edit-tone").value = ev.tone || "";
          document.getElementById("edit-active").checked = ev.active;

          let freqArr = ev.frequency || [];
          if (typeof freqArr === "string") {
            try {
              freqArr = JSON.parse(freqArr);
            } catch {
              freqArr = [];
            }
          }
          const checkboxes = document.querySelectorAll(
            "#edit-frequency-group input[type=checkbox]"
          );
          checkboxes.forEach((cb) => {
            cb.checked = freqArr.includes(cb.value);
          });
        } else if (type === "special") {
          document.getElementById("edit-normal-fields").style.display = "none";
          document.getElementById("edit-special-fields").style.display = "";

          document.getElementById("edit-date").value = ev.date || "";
          document.getElementById("edit-time-special").value = ev.time || "";
          document.getElementById("edit-description").value = ev.description || "";
          document.getElementById("edit-tone-special").value = ev.tone || "";
          document.getElementById("edit-completed").checked = ev.completed;
        }

        panel.style.display = "block";
        panel.scrollIntoView({ behavior: "smooth" });
      } catch (err) {
        alert("Failed to load event data for editing");
      }
    }

    function hideEditPanel() {
      const panel = document.getElementById("edit-panel");
      panel.style.display = "none";
      const editError = document.getElementById("edit-error");
      editError.style.display = "none";
      editError.textContent = "";
      document.getElementById("edit-form").reset();
    }

    document.getElementById("edit-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("edit-id").value;
      const type = document.getElementById("edit-type").value;
      const errorDiv = document.getElementById("edit-error");
      errorDiv.style.display = "none";
      errorDiv.textContent = "";

      if (type === "normal") {
        const title = document.getElementById("edit-title").value.trim();
        const time = document.getElementById("edit-time").value;
        const delayStr = document.getElementById("edit-delay").value.trim();
        const tone = document.getElementById("edit-tone").value;
        const active = document.getElementById("edit-active").checked;

        const freqCheckboxes = document.querySelectorAll(
          "#edit-frequency-group input[type=checkbox]"
        );
        const frequency = Array.from(freqCheckboxes)
          .filter((cb) => cb.checked)
          .map((cb) => cb.value.toLowerCase());

        if (!title || !time || !tone) {
          errorDiv.textContent = "Please fill in all required fields.";
          errorDiv.style.display = "block";
          return;
        }
        if (frequency.length === 0) {
          errorDiv.textContent = "Select at least one frequency day.";
          errorDiv.style.display = "block";
          return;
        }
        const delay = parseInt(delayStr) || 0;
        if (delay < 0) {
          errorDiv.textContent = "Delay cannot be negative.";
          errorDiv.style.display = "block";
          return;
        }

        const payload = {
          title,
          time,
          delay,
          tone,
          active,
          frequency,
        };

        try {
          const res = await fetch(`${API_BASE}/normalEvents/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();

          if (res.ok) {
            alert("Normal event updated successfully!");
            populateEvents();
            hideEditPanel();
          } else {
            errorDiv.textContent = data.error || "Update failed.";
            errorDiv.style.display = "block";
          }
        } catch (err) {
          errorDiv.textContent = "Error updating event.";
          errorDiv.style.display = "block";
        }
      } else if (type === "special") {
        const date = document.getElementById("edit-date").value;
        const time = document.getElementById("edit-time-special").value;
        const description = document.getElementById("edit-description").value.trim();
        const tone = document.getElementById("edit-tone-special").value;
        const completed = document.getElementById("edit-completed").checked;

        if (!date || !time || !description || !tone) {
          errorDiv.textContent = "Please fill in all required fields.";
          errorDiv.style.display = "block";
          return;
        }

        const payload = {
          date,
          time,
          description,
          tone,
          completed,
        };

        try {
          const res = await fetch(`${API_BASE}/specialEvents/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();

          if (res.ok) {
            alert("Special event updated successfully!");
            populateEvents();
            hideEditPanel();
          } else {
            errorDiv.textContent = data.error || "Update failed.";
            errorDiv.style.display = "block";
          }
        } catch (err) {
          errorDiv.textContent = "Error updating event.";
          errorDiv.style.display = "block";
        }
      }
    });

    document.getElementById("edit-cancel").onclick = (e) => {
      e.preventDefault();
      hideEditPanel();
    };

    window.onload = () => {
      updateClock();
      setInterval(updateClock, 1000);

      populateEvents();
    };
  </script>
</body>
</html>
